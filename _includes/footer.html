<!-- 这是一个标准的 Chirpy 页脚结构，包含了我们的中文目录修复脚本 -->

<footer class="footer">
  <div class="container">
    <p class="text-center text-muted">
      © {{ site.time | date: '%Y' }}
      <a href="{{ site.url }}">{{ site.title }}</a>.
      <br>
      Powered by <a href="https://jekyllrb.com" target="_blank">Jekyll</a> &
      <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank">Chirpy</a>
    </p>
  </div>

  <!-- 【中文目录修复脚本 - 极简稳定版】 -->
  <script>
  (function() {
    // 调试信息：看到这个说明脚本加载了
    console.log(">>> TOC Fix: Script loaded. Waiting for tocbot... <<<");

    // 1. 定义点击跳转逻辑
    function fixClick(e) {
      // 找到点击的链接
      var link = e.target.closest('a');
      if (!link) return;
      
      var href = link.getAttribute('href');
      // 只处理目录链接 (# 开头)
      if (!href || !href.startsWith('#')) return;

      // 阻止默认行为 (这是关键，阻止 tocbot 乱跳)
      e.preventDefault();

      // 解码中文 ID (比如 "%E4%B8%AD" -> "中")
      var targetId = decodeURIComponent(href.substring(1));
      var targetEl = document.getElementById(targetId);
      
      // 备用：有时候 ID 里有空格或其他怪字符，尝试用 name 找
      if (!targetEl) targetEl = document.getElementsByName(targetId)[0];

      if (targetEl) {
        // 计算滚动位置
        // 56px 是导航栏高度，+20px 留点呼吸空间
        var offset = 20 + 20; 
        var top = targetEl.getBoundingClientRect().top + window.scrollY - offset;

        // 执行滚动
        window.scrollTo({ top: top, behavior: 'smooth' });

        // 修改 URL (不刷新页面)
        history.pushState(null, null, href);
      } else {
        console.warn("TOC Fix: Can't find element with ID:", targetId);
      }
    }

    // 2. 等待 tocbot 插件加载完毕，然后注入我们的逻辑
    var checkInterval = setInterval(function() {
      var toc = document.querySelector('#toc');
      
      // 只有当 window.tocbot 存在，且目录里已经生成了 HTML 链接时，才开始干活
      if (window.tocbot && toc && toc.querySelector('a')) {
        clearInterval(checkInterval);
        console.log(">>> TOC Fix: Tocbot found. Applying patch... <<<");

        // 使用官方 API 刷新配置
        tocbot.refresh({
          tocSelector: '#toc',
          contentSelector: '.content',
          headingSelector: 'h2, h3, h4',
          ignoreSelector: '[data-toc-skip]',
          orderedList: false,
          headingsOffset: 70, // 设置高亮感应区
          scrollSmooth: false, // 【重要】关闭自带滚动，由我们接管
          onClick: fixClick    // 【重要】注入上面的点击函数
        });
        
        console.log(">>> TOC Fix: Patch applied successfully. <<<");
      }
    }, 100); // 每 0.1 秒检查一次
  })();
  </script>
</footer>