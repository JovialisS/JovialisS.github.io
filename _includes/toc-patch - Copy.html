<script>
/* Chirpy 中文目录修复补丁 (Final Tuned Version) */
(function() {
  var TOC_SELECTOR = '#toc';
  var CONTENT_SELECTOR = '.content';
  
  // 1. 定义滚动留白：数字越小，标题离顶部越近 (Chirpy 导航栏约 56px)
  // 我们设为 60，保证标题刚好露出来，不被挡住
  var SCROLL_OFFSET = 60; 

  // 2. 定义插件感应区：必须比 SCROLL_OFFSET 大！
  // 设为 80，意味着只要标题滚到距离顶部 80px 以内，插件就会高亮它
  // 80 > 60，确保滚动停止时，必定落在感应区内
  var DETECT_OFFSET = 80;

  function customClick(e) {
    var link = e.target.closest('a');
    if (!link) return;
    var href = link.getAttribute('href');
    if (!href || !href.startsWith('#')) return;

    e.preventDefault();

    var targetId = decodeURIComponent(href.substring(1));
    var targetEl = document.getElementById(targetId);
    if (!targetEl) targetEl = document.getElementsByName(targetId)[0];

    if (targetEl) {
      // 计算滚动位置
      var elementPosition = targetEl.getBoundingClientRect().top + window.scrollY;
      var offsetPosition = elementPosition - SCROLL_OFFSET;

      window.scrollTo({
        top: offsetPosition,
        behavior: "smooth"
      });

      // --- 关键优化：手动强制高亮 ---
      // 在滚动开始的一瞬间，先把样式改对，给用户“极快”的感觉
      // 随后 tocbot 的滚动监听会接手，因为我们在感应区内，它会保持这个高亮
      updateTempActive(link);

      history.pushState(null, null, href);
    }
  }

  // 辅助函数：手动切换高亮样式
  function updateTempActive(targetLink) {
    var toc = document.querySelector(TOC_SELECTOR);
    if (!toc) return;

    // 移除旧高亮
    toc.querySelectorAll('.is-active-link').forEach(function(el) { el.classList.remove('is-active-link'); });
    toc.querySelectorAll('.is-active-li').forEach(function(el) { el.classList.remove('is-active-li'); });

    // 添加新高亮
    targetLink.classList.add('is-active-link');
    var parentLi = targetLink.closest('li');
    if (parentLi) {
      parentLi.classList.add('is-active-li');
      // 展开父级折叠
      var grandParent = parentLi.parentElement.closest('.toc-list-item');
      while (grandParent) {
        grandParent.classList.add('is-active-li');
        grandParent = grandParent.parentElement.closest('.toc-list-item');
      }
    }
  }

  var waitToc = setInterval(function() {
    var toc = document.querySelector(TOC_SELECTOR);
    if (window.tocbot && toc && toc.querySelector('a')) {
      clearInterval(waitToc);
      
      console.log("Applying ToC Patch (Offset Tuned)...");

      tocbot.refresh({
        tocSelector: TOC_SELECTOR,
        contentSelector: CONTENT_SELECTOR,
        headingSelector: 'h2, h3, h4',
        ignoreSelector: '[data-toc-skip]',
        orderedList: false,
        
        // 关键设置：这里设置感应区大小
        headingsOffset: DETECT_OFFSET, 
        
        scrollSmooth: false, 
        onClick: customClick 
      });
    }
  }, 100);
})();
</script>