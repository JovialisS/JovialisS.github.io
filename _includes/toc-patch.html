<script>
/* Chirpy 中文目录修复补丁 (Final Tuned Version) */
(function() {
  var TOC_SELECTOR = '#toc';
  var CONTENT_SELECTOR = '.content';
  
  // --- 参数微调区 ---
  
  // 1. 滚动留白 (Scroll Offset)：决定标题停在屏幕的什么位置
  // 如果你觉得“位置太靠下，看到了上一级标题”，请把这个数字改小 (例如 50, 45)。
  // 如果你觉得“标题被顶部导航栏挡住了”，请把这个数字改大 (例如 60, 65)。
  // Chirpy 的导航栏高度通常是 56px 左右。
  var SCROLL_OFFSET = 30; 

  // 2. 插件感应区 (Detect Offset)：决定滚动监听的高亮灵敏度
  // 这个数字【必须】比上面的 SCROLL_OFFSET 大至少 10-20。
  // 这样能确保滚动停止时，该标题一定处于“激活范围”内，防止高亮乱跳。
  var DETECT_OFFSET = 70; 

  // ----------------

  function customClick(e) {
    var link = e.target.closest('a');
    if (!link) return;
    var href = link.getAttribute('href');
    if (!href || !href.startsWith('#')) return;

    e.preventDefault();

    var targetId = decodeURIComponent(href.substring(1));
    var targetEl = document.getElementById(targetId);
    if (!targetEl) targetEl = document.getElementsByName(targetId)[0];

    if (targetEl) {
      var elementPosition = targetEl.getBoundingClientRect().top + window.scrollY;
      var offsetPosition = elementPosition - SCROLL_OFFSET;

      window.scrollTo({
        top: offsetPosition,
        behavior: "smooth"
      });

      updateTempActive(link);
      history.pushState(null, null, href);
    }
  }

  function updateTempActive(targetLink) {
    var toc = document.querySelector(TOC_SELECTOR);
    if (!toc) return;

    toc.querySelectorAll('.is-active-link').forEach(function(el) { el.classList.remove('is-active-link'); });
    toc.querySelectorAll('.is-active-li').forEach(function(el) { el.classList.remove('is-active-li'); });

    targetLink.classList.add('is-active-link');
    var parentLi = targetLink.closest('li');
    if (parentLi) {
      parentLi.classList.add('is-active-li');
      var grandParent = parentLi.parentElement.closest('.toc-list-item');
      while (grandParent) {
        grandParent.classList.add('is-active-li');
        grandParent = grandParent.parentElement.closest('.toc-list-item');
      }
    }
  }

  var waitToc = setInterval(function() {
    var toc = document.querySelector(TOC_SELECTOR);
    if (window.tocbot && toc && toc.querySelector('a')) {
      clearInterval(waitToc);
      console.log("Applying ToC Patch (Offset: " + SCROLL_OFFSET + ")");

      tocbot.refresh({
        tocSelector: TOC_SELECTOR,
        contentSelector: CONTENT_SELECTOR,
        headingSelector: 'h2, h3, h4',
        ignoreSelector: '[data-toc-skip]',
        orderedList: false,
        headingsOffset: DETECT_OFFSET, 
        scrollSmooth: false, 
        onClick: customClick 
      });
    }
  }, 100);
})();
</script>